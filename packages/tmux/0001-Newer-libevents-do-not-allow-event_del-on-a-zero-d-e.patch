From e3a54ed0f46a4ac65c0abcdc445b291388fcdbdc Mon Sep 17 00:00:00 2001
From: nicm <nicm>
Date: Wed, 26 Nov 2025 19:02:03 +0000
Subject: [PATCH] Newer libevents do not allow event_del on a zero'd event.

---
 tty.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/tty.c b/tty.c
index bd0c6b3..cfff58c 100644
--- a/tty.c
+++ b/tty.c
@@ -35,6 +35,8 @@
 
 static int	tty_log_fd = -1;
 
+static void	tty_start_timer_callback(int, short, void *);
+static void	tty_clipboard_query_callback(int, short, void *);
 static void	tty_set_italics(struct tty *);
 static int	tty_try_colour(struct tty *, int, const char *);
 static void	tty_force_cursor_colour(struct tty *, int);
@@ -291,6 +293,8 @@ tty_open(struct tty *tty, char **cause)
 	if (tty->out == NULL)
 		fatal("out of memory");
 
+	evtimer_set(&tty->clipboard_timer, tty_clipboard_query_callback, tty);
+	evtimer_set(&tty->start_timer, tty_start_timer_callback, tty);
 	evtimer_set(&tty->timer, tty_timer_callback, tty);
 
 	tty_start_tty(tty);
@@ -322,7 +326,6 @@ tty_start_start_timer(struct tty *tty)
 
 	log_debug("%s: start timer started", c->name);
 	evtimer_del(&tty->start_timer);
-	evtimer_set(&tty->start_timer, tty_start_timer_callback, tty);
 	evtimer_add(&tty->start_timer, &tv);
 }
 
@@ -440,6 +443,7 @@ tty_stop_tty(struct tty *tty)
 	tty->flags &= ~TTY_STARTED;
 
 	evtimer_del(&tty->start_timer);
+	evtimer_del(&tty->clipboard_timer);
 
 	event_del(&tty->timer);
 	tty->flags &= ~TTY_BLOCK;
@@ -3106,6 +3110,5 @@ tty_clipboard_query(struct tty *tty)
 	tty_putcode_ss(tty, TTYC_MS, "", "?");
 
 	tty->flags |= TTY_OSC52QUERY;
-	evtimer_set(&tty->clipboard_timer, tty_clipboard_query_callback, tty);
 	evtimer_add(&tty->clipboard_timer, &tv);
 }
-- 
2.52.0

